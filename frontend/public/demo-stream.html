<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyX Agent - Streaming Demo</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
        }
        .thinking-panel {
            border-left: 3px solid #667eea;
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.1) 0%, transparent 100%);
        }
        .thinking-text {
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            line-height: 1.6;
        }
        .stream-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .content-preview {
            background: #f9fafb;
            border-radius: 8px;
            padding: 16px;
            font-size: 14px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="max-w-4xl mx-auto p-6">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h1 class="text-2xl font-bold text-gray-900 mb-2">ğŸŒŠ StudyX Agent - Streaming Demo</h1>
            <p class="text-gray-600">å®æ—¶å±•ç¤ºAIçš„æ€è€ƒè¿‡ç¨‹å’Œç”Ÿæˆå†…å®¹</p>
        </div>

        <!-- Chat Container -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6 min-h-[400px]" id="chatContainer">
            <div id="messages" class="space-y-4"></div>
        </div>

        <!-- Input -->
        <div class="bg-white rounded-lg shadow-sm p-4">
            <div class="flex gap-4">
                <input 
                    type="text" 
                    id="messageInput" 
                    placeholder="è¾“å…¥æ¶ˆæ¯ï¼Œä¾‹å¦‚ï¼šç»™æˆ‘5é“å…‰åˆä½œç”¨çš„é¢˜"
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                    onkeypress="if(event.key==='Enter') sendMessage()"
                />
                <button 
                    onclick="sendMessage()"
                    id="sendBtn"
                    class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition"
                >
                    å‘é€
                </button>
            </div>
            <div class="mt-2 text-sm text-gray-500">
                <span class="stream-indicator"></span>
                <span class="ml-2">æµå¼å“åº”å·²å¯ç”¨</span>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        const USER_ID = 'demo-user';
        const SESSION_ID = 'demo-session';

        let currentStreamController = null;

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            console.log('ğŸ“¤ Sending:', message);
            input.value = '';
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addUserMessage(message);
            
            // åˆ›å»ºAgentå“åº”å®¹å™¨
            const responseId = `response-${Date.now()}`;
            createStreamResponse(responseId);
            
            try {
                const response = await fetch(`${API_BASE}/api/agent/chat-stream`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: USER_ID,
                        session_id: SESSION_ID,
                        message: message
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const {done, value} = await reader.read();
                    
                    if (done) break;
                    
                    buffer += decoder.decode(value, {stream: true});
                    
                    // å¤„ç†å¤šä¸ªäº‹ä»¶
                    const events = buffer.split('\n\n');
                    buffer = events.pop(); // ä¿ç•™æœªå®Œæˆçš„éƒ¨åˆ†
                    
                    for (const event of events) {
                        if (event.startsWith('data: ')) {
                            const data = JSON.parse(event.substring(6));
                            handleStreamEvent(responseId, data);
                        }
                    }
                }
                
                console.log('âœ… Stream complete');
                
            } catch (error) {
                console.error('âŒ Stream error:', error);
                appendError(responseId, error.message);
            }
        }

        function handleStreamEvent(responseId, data) {
            console.log('[Stream]', data.type, data);
            
            if (data.type === 'status') {
                updateStatus(responseId, data.message);
            } 
            else if (data.type === 'thinking') {
                appendThinking(responseId, data.text);
            } 
            else if (data.type === 'content') {
                appendContent(responseId, data.text);
            } 
            else if (data.type === 'done') {
                finishStream(responseId, data);
            } 
            else if (data.type === 'error') {
                appendError(responseId, data.message);
            }
        }

        function addUserMessage(text) {
            const messagesDiv = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = 'flex justify-end';
            div.innerHTML = `
                <div class="max-w-xl bg-purple-600 text-white rounded-lg px-4 py-3">
                    ${escapeHtml(text)}
                </div>
            `;
            messagesDiv.appendChild(div);
            scrollToBottom();
        }

        function createStreamResponse(id) {
            const messagesDiv = document.getElementById('messages');
            const div = document.createElement('div');
            div.id = id;
            div.className = 'space-y-4';
            div.innerHTML = `
                <!-- Status -->
                <div class="flex items-center gap-2 text-sm text-gray-600">
                    <div class="stream-indicator"></div>
                    <span id="${id}-status">æ­£åœ¨å¤„ç†...</span>
                </div>
                
                <!-- Thinking Panel (collapsible) -->
                <details class="thinking-panel rounded-lg p-4" open>
                    <summary class="cursor-pointer font-semibold text-purple-700 mb-2">
                        ğŸ§  æ€è€ƒè¿‡ç¨‹
                    </summary>
                    <div id="${id}-thinking" class="thinking-text text-sm text-gray-700 mt-2">
                        <!-- Thinking content will be appended here -->
                    </div>
                </details>
                
                <!-- Content Preview -->
                <div class="content-preview">
                    <div class="text-xs text-gray-500 mb-2">ğŸ“ ç”Ÿæˆå†…å®¹</div>
                    <pre id="${id}-content" class="text-sm text-gray-800 whitespace-pre-wrap overflow-x-auto"></pre>
                </div>
                
                <!-- Final Result (hidden until done) -->
                <div id="${id}-result" class="hidden"></div>
            `;
            messagesDiv.appendChild(div);
            scrollToBottom();
        }

        function updateStatus(id, message) {
            const statusEl = document.getElementById(`${id}-status`);
            if (statusEl) {
                statusEl.textContent = message;
            }
        }

        function appendThinking(id, text) {
            const thinkingEl = document.getElementById(`${id}-thinking`);
            if (thinkingEl) {
                thinkingEl.textContent += text;
                scrollToBottom();
            }
        }

        function appendContent(id, text) {
            const contentEl = document.getElementById(`${id}-content`);
            if (contentEl) {
                contentEl.textContent += text;
                scrollToBottom();
            }
        }

        function finishStream(id, data) {
            // éšè—æµå¼é¢„è§ˆ
            const container = document.getElementById(id);
            const thinking = container.querySelector('details');
            const contentPreview = container.querySelector('.content-preview');
            const statusDiv = container.querySelector('[id$="-status"]').parentElement;
            
            statusDiv.remove();
            contentPreview.remove();
            
            // é»˜è®¤æŠ˜å æ€è€ƒè¿‡ç¨‹
            thinking.removeAttribute('open');
            
            // æ˜¾ç¤ºæœ€ç»ˆæ¸²æŸ“ç»“æœ
            const resultDiv = document.getElementById(`${id}-result`);
            resultDiv.classList.remove('hidden');
            
            try {
                // æ ¹æ®content_typeæ¸²æŸ“
                const content = data.content;
                const contentType = data.content_type;
                
                if (contentType === 'quiz_set') {
                    resultDiv.innerHTML = renderQuiz(content);
                } else if (contentType === 'explanation') {
                    resultDiv.innerHTML = renderExplanation(content);
                } else {
                    resultDiv.innerHTML = `<pre class="text-sm">${JSON.stringify(content, null, 2)}</pre>`;
                }
            } catch (e) {
                console.error('âŒ Render error:', e);
                resultDiv.innerHTML = `<div class="text-red-600">æ¸²æŸ“å¤±è´¥: ${e.message}</div>`;
            }
            
            console.log('âœ… Stream finished');
            scrollToBottom();
        }

        function appendError(id, message) {
            const container = document.getElementById(id);
            if (container) {
                container.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-start gap-3">
                            <span class="text-red-600">âŒ</span>
                            <div>
                                <div class="font-semibold text-red-800">é”™è¯¯</div>
                                <div class="text-sm text-red-700">${escapeHtml(message)}</div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Simple renderers
        function renderQuiz(content) {
            const questions = content.questions || [];
            let html = '<div class="space-y-4">';
            
            questions.forEach((q, idx) => {
                html += `
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="font-semibold mb-2">${idx + 1}. ${escapeHtml(q.question_text)}</div>
                        <div class="space-y-1 ml-4">
                            ${(q.options || []).map(opt => `<div class="text-sm text-gray-700">${escapeHtml(opt)}</div>`).join('')}
                        </div>
                        <div class="mt-2 text-sm text-green-600">âœ“ ç­”æ¡ˆ: ${q.correct_answer}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        function renderExplanation(content) {
            const concept = content.concept || '';
            const intuition = content.intuition || '';
            const examples = content.examples || [];
            
            let html = `
                <div class="space-y-4">
                    <div class="text-xl font-bold">${escapeHtml(concept)}</div>
                    <div class="text-gray-700">${escapeHtml(intuition)}</div>
            `;
            
            if (examples.length > 0) {
                html += '<div class="space-y-3 mt-4">';
                examples.forEach((ex, idx) => {
                    html += `
                        <div class="border-l-4 border-purple-500 pl-4">
                            <div class="font-semibold">ä¾‹å­ ${idx + 1}: ${escapeHtml(ex.title)}</div>
                            <div class="text-sm text-gray-600 mt-1">${escapeHtml(ex.description)}</div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function scrollToBottom() {
            window.scrollTo({
                top: document.body.scrollHeight,
                behavior: 'smooth'
            });
        }

        // Auto-focus input on load
        window.onload = () => {
            document.getElementById('messageInput').focus();
        };
    </script>
</body>
</html>

